!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.studiojs=e()}(this,function(){"use strict";function t(t){return"[object Array]"==Object.prototype.toString.call(t)}function e(t,e){var i=document.createElement("canvas");return i.width=t,i.height=e,i.ctx=i.getContext("2d"),i}function i(t){for(var e,i,n,r=[],a=0;a<t.length;a++)if(e=String(t[a]).split("-"),e[1]=void 0===e[1]?e[0]:e[1],i=e[0],n=e[1],isNaN(i))r.push(i);else if(i<=n)for(var s=Number(i);s<=Number(n);s++)r.push(s);else for(var s=Number(i);s>=Number(n);s--)r.push(s);return r}function n(t){var e={};for(var n in t)e[n]=i(t[n]);return e}function r(t,e,i){for(var n=0,r=t.length,a=0,s=[];n<r;n++)!function(o){var u=new Image;u.onload=function(){s[o]=u,++a===r&&e&&e("complete",s)},u.src=i?i+t[n]:t[n]}(n)}var a=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},s=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),o=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},u=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},h=function(t){if(Array.isArray(t)){for(var e=0,i=Array(t.length);e<t.length;e++)i[e]=t[e];return i}return Array.from(t)},c=function(){function t(){a(this,t),this.listeners=[]}return s(t,[{key:"trigger",value:function(t){for(var e=arguments.length,i=Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return this.listeners.filter(function(e){var n=t===e.type?1:0;return n&&e.callback.apply(e,i),n}).reduce(function(t,e){return t+e},0)}},{key:"on",value:function(t,e){return this.listeners.push({type:t,callback:e}),this}}]),t}(),f={onClear:"clear",onReady:"ready",onStart:"start",onFrame:"frame",onEnd:"end"};for(var l in f)c.prototype[l]=function(t){return function(e){return this.on(f[t],e),this}}(l);return{Stage:function(i){function n(t){a(this,n);var e=u(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e.canvas=t,e.ctx=e.canvas.getContext("2d"),e.tracks=[],e}return o(n,i),s(n,[{key:"add",value:function(i){var n=this;(t(i)?i:[i]).map(function(t){t.canvas=e(n.canvas.width,n.canvas.height),t.stage=n,n.tracks.push(t)})}},{key:"draw",value:function(t,e){for(var i=this.tracks,n=0,r=[],a=i.length;n<a;n++)if(i[n].isEnable){var s=null;s="next"===t?i[n].update(e):"prev"===t?i[n].prev(e):i[n].to(t),s&&r.push(s)}if(r.length>0){this.isEnd=!1,r=r.sort(function(t,e){return t.zIndex-e.zIndex>0}),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(var o=0;o<r.length;o++)this.ctx.drawImage(r[o].canvas,0,0);this.trigger("frame")}else this.trigger("end"),this.isEnd=!0}},{key:"update",value:function(t){this.draw("next",t)}},{key:"prev",value:function(t){this.draw("prev",t)}},{key:"get",value:function(t){for(var e=this.tracks,i=0,n=0,r=e.length;i<r;i++)"curIndex"===t?n=e[i].getCurIndex():"fLen"===t?n=e[i].getLen("frames"):"mLen"===t&&(n=e[i].getLen("materials")),n=i>n?i:n;return n}},{key:"getCurIndex",value:function(){return this.get("curIndex")}},{key:"getLen",value:function(t){return"frames"===t?this.get("fLen"):"materials"===t?this.get("mLen"):0}}]),n}(c),Track:function(){function t(e,i){a(this,t),this._id=0,this.zIndex=e||0,this.isEnable=!0,this.materials=[],this.curM=null,i&&(this.canvas=i,this.canvas.ctx=i.getContext("2d"))}return s(t,[{key:"add",value:function(t,i){t.id=this._id++,t.track=this,t.canvas=e(this.canvas.width,this.canvas.height);var n=void 0!==i?this.getMIndex(this.curM)+i+1:this.materials.length;return this.materials.splice(n,0,t),t}},{key:"update",value:function(t){var e=this.curM=this.curM||this.materials[0];if(e){if(!e.isEnd){var i=e.update(t);return this.draw(i.canvas)}var n=this.getNext();if(n&&n.isReady)return this.curM=n,this.curM.actIndex=-1,this.update(!0)}}},{key:"prev",value:function(t){var e=this.curM=this.curM||this.materials[0];if(!(e.actIndex<=0)){var i=e.prev();return this.draw(i.canvas)}var n=this.getPrev();if(n&&n.isReady)return this.curM=n,this.curM.actIndex=this.curM.animation.length-1,this.prev()}},{key:"draw",value:function(t){return this.canvas.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.ctx.drawImage(t,0,0),this}},{key:"getMIndex",value:function(t){for(var e=0,i=this.materials,n=i.length;e<n;e++)if(i[e].id==t.id)return e;return 0}},{key:"getPrev",value:function(){var t=this.getMIndex(this.curM);return this.materials[t-1]}},{key:"getNext",value:function(){var t=this.getMIndex(this.curM);return this.materials[t+1]}},{key:"play",value:function(){this.isEnable=!0,this.stage.trigger("ready")}},{key:"pause",value:function(){this.isEnable=!1}},{key:"getLen",value:function(t){return"frames"===t?this.materials.reduce(function(t,e){return(t&&t.animation.length||0)+(e&&e.animation.length||0)},0):"materials"===t?this.materials.length:void 0}},{key:"getCurIndex",value:function(t){for(var e=0,i=this.materials,n=0,r=i.length;n<r;n++)if(i[n].id==this.curM.id){for(var a=0;a<n;a++){var s=i[n].animation.length;e+=s}return e+=i[n].actIndex}}}]),t}(),Frame:function(e){function c(t,e,s,o){a(this,c);var h=u(this,(c.__proto__||Object.getPrototypeOf(c)).call(this)),f=t.imgPrefix,l=t.images,d=t.animations,v=t.frames;return h.animations=d,h.animation=d&&d[e]||["0-"+(l.length-1)],h.fps=s,h.animation=i(h.animation||[]),h.animations=n(h.animations||{}),h.listeners=[],h.actIndex=-1,"string"==typeof l[0]?r(l,function(t,e){"complete"===t&&(h.sources=h.formate(e,v),h.isReady=!0)},f):(h.sources=h.formate(l,v),h.isReady=!0),o&&(h.canvas=o,h.canvas.ctx=o.getContext("2d")),h.times=0,h}return o(c,e),s(c,[{key:"formate",value:function(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=[];if(t(i))for(var r,a=0;a<i.length;a++)r=i[a],n.push({source:e[r[6]||0],loc:{x:r[0]||0,y:r[1]||0,offX:r[4]||0,offY:r[5]||0},width:r[2],height:r[3]});else for(var s,o=i.width,u=i.height,a=0;a<e.length;a++){s=e[a];for(var h=s.width,c=s.height,f=o||h,l=u||c,d=h/f,v=c/l,g=0;g<v;g++)for(var p=0;p<d;p++)n.push({source:s,loc:{x:p*f,y:g*l,offX:i.offX||0,offY:i.offY||0},width:f,height:l})}return n}},{key:"update",value:function(t){if(this.isReady){if(!t){if(++this.times<60/this.fps)return this;this.times=0}return this.actIndex+1>this.animation.length-1?(this.isEnd=!0,this):(++this.actIndex,this.draw(this))}}},{key:"prev",value:function(t){if(this.isReady){if(!t){if(++this.times<60/this.fps)return this;this.times=0}return--this.actIndex<0?this:this.draw(this)}}},{key:"draw",value:function(t,e){var i=t,n=void 0!==e?e:i.actIndex,r=i.animation,a=r[n];if(isNaN(a)){var s=i.animations[a];s&&r.splice.apply(r,[n,1].concat(h(s))),a=r[n]}if(void 0!==a){var o=t,u=o.sources[a],c=u.source,f=u.loc,l=this.canvas.ctx,d=this.canvas;d._rect={x:i.x||0,y:i.y||0,width:u.width*(i.scale||1),height:u.height*(i.scale||1)},l.clearRect(0,0,d.width,d.height),"horizintal"===i.flip&&(d._rect.x=d.width-(i.x||0)-u.width*(i.scale||1),l.translate(d.width,0),l.scale(-1,1));var v=(i.x||0)+(f.offX||0),g=(i.y||0)+(f.offY||0);return l.drawImage(c,f.x||0,f.y||0,u.width,u.height,v,g,u.width*(i.scale||1),u.height*(i.scale||1)),"horizintal"===i.flip&&(l.translate(d.width,0),l.scale(-1,1)),this.curM=i,0===n&&i.trigger("start",i),i.trigger("frame",n,i),n===i.animation.length-1&&i.trigger("end",i),this}}},{key:"clear",value:function(t,e){return this.trigger("clear",this),this.animation=[],this}}]),c}(c),loadImage:r}});
