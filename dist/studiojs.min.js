/**
 * studiojs v0.0.3 By joeyguo
 * HomePage: https://github.com/gkajs/studiojs
 * MIT Licensed.
 */

!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.studiojs=e()}(this,function(){"use strict";function t(t){return"[object Array]"==Object.prototype.toString.call(t)}function e(t,e){var n=document.createElement("canvas");return n.width=t,n.height=e,n.ctx=n.getContext("2d"),n}function n(t){for(var e,n,i,r=[],a=0;a<t.length;a++)if(e=String(t[a]).split("-"),e[1]=void 0===e[1]?e[0]:e[1],n=e[0],i=e[1],isNaN(n))r.push(n);else if(n<=i)for(var s=Number(n);s<=Number(i);s++)r.push(s);else for(var s=Number(n);s>=Number(i);s--)r.push(s);return r}function i(t){var e={};for(var i in t)e[i]=n(t[i]);return e}function r(t,e,n){for(var i=0,r=t.length,a=0,s=[];i<r;i++)!function(o){var u=new Image;u.onload=function(){s[o]=u,++a===r&&e&&e("complete",s)},u.src=n?n+t[i]:t[i]}(i)}var a=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},s=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),o=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},u=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},c=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},h=function(){function t(){a(this,t),this.listeners=[]}return s(t,[{key:"trigger",value:function(t){for(var e=arguments.length,n=Array(e>1?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];return this.listeners.filter(function(e){var i=t===e.type?1:0;return i&&e.callback.apply(e,n),i}).reduce(function(t,e){return t+e},0)}},{key:"on",value:function(t,e){return this.listeners.push({type:t,callback:e}),this}}]),t}(),f={onClear:"clear",onReady:"ready",onStart:"start",onFrame:"frame",onEnd:"end"};for(var l in f)h.prototype[l]=function(t){return function(e){return this.on(f[t],e),this}}(l);return{Stage:function(n){function i(t){a(this,i);var e=u(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));return e.canvas=t,e.ctx=e.canvas.getContext("2d"),e.tracks=[],e}return o(i,n),s(i,[{key:"add",value:function(n){var i=this;(t(n)?n:[n]).map(function(t){t.canvas=e(i.canvas.width,i.canvas.height),t.stage=i,i.tracks.push(t)})}},{key:"draw",value:function(t,e){for(var n=this.tracks,i=0,r=[],a=n.length;i<a;i++)if(n[i].isEnable){var s=null;s="next"===t?n[i].update(e):"prev"===t?n[i].prev(e):n[i].to(t),s&&r.push(s)}if(r.length>0){this.isEnd=!1,r=r.sort(function(t,e){return t.zIndex-e.zIndex>0}),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);for(var o=0;o<r.length;o++)this.ctx.drawImage(r[o].canvas,0,0);this.trigger("frame")}else this.trigger("end"),this.isEnd=!0}},{key:"update",value:function(t){this.draw("next",t)}},{key:"prev",value:function(t){this.draw("prev",t)}},{key:"get",value:function(t){for(var e=this.tracks,n=0,i=0,r=e.length;n<r;n++)"curIndex"===t?i=e[n].getCurIndex():"fLen"===t?i=e[n].getLen("frames"):"mLen"===t&&(i=e[n].getLen("materials")),i=n>i?n:i;return i}},{key:"getCurIndex",value:function(){return this.get("curIndex")}},{key:"getLen",value:function(t){return"frames"===t?this.get("fLen"):"materials"===t?this.get("mLen"):0}}]),i}(h),Track:function(){function n(t,e){a(this,n),this._id=0,this.zIndex=e||0,this.isEnable=!0,this.materials=[],this.curM=null,t&&(this.canvas=t,this.canvas.ctx=t.getContext("2d"))}return s(n,[{key:"add",value:function(n,i){var r=this;return(t(n)?n:[n]).map(function(t){t.id=r._id++,t.track=r,t.canvas=e(r.canvas.width,r.canvas.height);var n=void 0!==i?r.getMIndex(r.curM)+i+1:r.materials.length;r.materials.splice(n,0,t)}),n}},{key:"update",value:function(t){var e=this.curM=this.curM||this.materials[0];if(e){if(!e.isEnd){var n=e.update(t);return this.draw(n.canvas)}var i=this.getNext();if(i&&i.isReady)return this.curM=i,this.curM.actIndex=-1,this.update(!0)}}},{key:"prev",value:function(t){var e=this.curM=this.curM||this.materials[0];if(!(e.actIndex<=0)){var n=e.prev();return this.draw(n.canvas)}var i=this.getPrev();if(i&&i.isReady)return this.curM=i,this.curM.actIndex=this.curM.animation.length-1,this.prev()}},{key:"draw",value:function(t){return this.canvas.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.canvas.ctx.drawImage(t,0,0),this}},{key:"getMIndex",value:function(t){for(var e=0,n=this.materials,i=n.length;e<i;e++)if(n[e].id==t.id)return e;return 0}},{key:"getPrev",value:function(){var t=this.getMIndex(this.curM);return this.materials[t-1]}},{key:"getNext",value:function(){var t=this.getMIndex(this.curM);return this.materials[t+1]}},{key:"play",value:function(){this.isEnable=!0,this.stage.trigger("ready")}},{key:"pause",value:function(){this.isEnable=!1}},{key:"getLen",value:function(t){return"frames"===t?this.materials.reduce(function(t,e){return(t&&t.animation.length||0)+(e&&e.animation.length||0)},0):"materials"===t?this.materials.length:void 0}},{key:"getCurIndex",value:function(t){for(var e=0,n=this.materials,i=0,r=n.length;i<r;i++)if(n[i].id==this.curM.id){for(var a=0;a<i;a++){var s=n[i].animation.length;e+=s}return e+=n[i].actIndex}}}]),n}(),Frame:function(e){function h(t,e,s,o){a(this,h);var c=u(this,(h.__proto__||Object.getPrototypeOf(h)).call(this)),f=e.imgPrefix,l=e.images,d=e.animations,v=e.frames;return c.animations=d,c.animation=d&&d[s]||["0-"+(l.length-1)],c.times=o,c.animation=n(c.animation||[]),c.animations=i(c.animations||{}),c.listeners=[],c.actIndex=-1,"string"==typeof l[0]?r(l,function(t,e){"complete"===t&&(c.sources=c.formate(e,v),c.isReady=!0)},f):(c.sources=c.formate(l,v),c.isReady=!0),t&&(c.canvas=t,c.canvas.ctx=t.getContext("2d")),c.count=0,c}return o(h,e),s(h,[{key:"formate",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=[];if(t(n))for(var r,a=0;a<n.length;a++)r=n[a],i.push({source:e[r[6]||0],loc:{x:r[0]||0,y:r[1]||0,offX:r[4]||0,offY:r[5]||0},width:r[2],height:r[3]});else for(var s,o=n.width,u=n.height,a=0;a<e.length;a++){s=e[a];for(var c=s.width,h=s.height,f=o||c,l=u||h,d=c/f,v=h/l,g=0;g<v;g++)for(var m=0;m<d;m++)i.push({source:s,loc:{x:m*f,y:g*l,offX:n.offX||0,offY:n.offY||0},width:f,height:l})}return i}},{key:"update",value:function(t){if(this.isReady){if(!t){if(++this.count<this.times)return this;this.count=0}return this.actIndex+1>this.animation.length-1?(this.isEnd=!0,this):(++this.actIndex,this.draw(this))}}},{key:"prev",value:function(t){if(this.isReady){if(!t){if(++this.count<this.times)return this;this.count=0}return--this.actIndex<0?this:this.draw(this)}}},{key:"draw",value:function(t,e){var n=t,i=void 0!==e?e:n.actIndex,r=n.animation,a=r[i];if(isNaN(a)){var s=n.animations[a];s&&r.splice.apply(r,[i,1].concat(c(s))),a=r[i]}if(void 0!==a){var o=t,u=o.sources[a],h=u.source,f=u.loc,l=this.canvas.ctx,d=this.canvas;d._rect={x:n.x||0,y:n.y||0,width:u.width*(n.scale||1),height:u.height*(n.scale||1)},l.clearRect(0,0,d.width,d.height),"horizintal"===n.flip&&(d._rect.x=d.width-(n.x||0)-u.width*(n.scale||1),l.translate(d.width,0),l.scale(-1,1));var v=(n.x||0)+(f.offX||0),g=(n.y||0)+(f.offY||0);return l.drawImage(h,f.x||0,f.y||0,u.width,u.height,v,g,u.width*(n.scale||1),u.height*(n.scale||1)),"horizintal"===n.flip&&(l.translate(d.width,0),l.scale(-1,1)),this.curM=n,0===i&&n.trigger("start",n),n.trigger("frame",i,n),i===n.animation.length-1&&n.trigger("end",n),this}}},{key:"clear",value:function(t,e){return this.trigger("clear",this),this.animation=[],this}}]),h}(h),loadImage:r}});
